<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lookmarket.chatbot.mapper.BoardBotMapper">

<!-- 리뷰 본문: g_name 정확 일치 -->
<select id="findLatestReviewsByGoodsName" resultType="map">
  SELECT r_id, m_id, g_name, r_star, r_content,
         DATE_FORMAT(r_date, '%Y-%m-%d %H:%i:%s') AS r_date
  FROM review
  WHERE g_name = #{gName}
  ORDER BY r_date DESC, r_id DESC
  LIMIT #{limit} OFFSET #{offset}
</select>

<!-- 리뷰 통계: g_name 정확 일치 -->
<select id="findReviewStatsByGoodsName" resultType="map">
  SELECT ROUND(AVG(r_star),1) AS avgStar,
         COUNT(*)            AS cnt
  FROM review
  WHERE g_name = #{gName}
</select>

<!-- LIKE 폴백 -->
<select id="findLatestReviewsByGoodsNameLike" resultType="map">
  SELECT r_id, m_id, g_name, r_star, r_content,
         DATE_FORMAT(r_date, '%Y-%m-%d %H:%i:%s') AS r_date
  FROM review
  WHERE g_name LIKE #{gNameLike}
  ORDER BY r_date DESC, r_id DESC
  LIMIT #{limit} OFFSET #{offset}
</select>

<select id="findReviewStatsByGoodsNameLike" resultType="map">
  SELECT ROUND(AVG(r_star),1) AS avgStar,
         COUNT(*)            AS cnt
  FROM review
  WHERE g_name LIKE #{gNameLike}
</select>

<!-- (옵션) 상품 정보 필요시 -->
<select id="findGoodsInfoByName" resultType="map">
  SELECT g_name, g_price, g_brand, g_stock
  FROM goods
  WHERE g_name = #{gName}
  ORDER BY g_id DESC
  LIMIT 1
</select>

</mapper>
